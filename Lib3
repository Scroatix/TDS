if not game:IsLoaded() then game.Loaded:Wait() end

-- Load GUI with error handling
local success, errorMsg = pcall(function()
    loadstring(game:HttpGet("https://raw.githubusercontent.com/DuxiiT/auto-strat/refs/heads/main/Sources/GuiSource.lua"))()
end)

if not success then
    warn("Failed to load GUI: " .. errorMsg)
    return
end

if not shared.AutoStratGUI then
    warn("GUI not loaded properly")
    return
end

local Console = shared.AutoStratGUI.Console

-- Wait for player properly
local players_service = game:GetService("Players")
local local_player = players_service.LocalPlayer or players_service.PlayerAdded:Wait()

-- Check if player exists
if not local_player then
    warn("Local player not found")
    return
end

local function identify_game_state()
    local temp_gui = local_player:WaitForChild("PlayerGui", 10)
    if not temp_gui then return "UNKNOWN" end
    
    while true do
        if temp_gui:FindFirstChild("LobbyGui") then
            return "LOBBY"
        elseif temp_gui:FindFirstChild("GameGui") then
            return "GAME"
        end
        task.wait(1)
    end
end

local game_state = identify_game_state() or "UNKNOWN"

-- Fix http request function
local send_request
if request then
    send_request = request
elseif http_request then
    send_request = http_request
elseif syn and syn.request then
    send_request = syn.request
elseif http and http.request then
    send_request = http.request
else
    warn("No HTTP function available - webhooks disabled")
    send_request = function() return {Success = false} end
end

-- // services & main refs
local teleport_service = game:GetService("TeleportService")
local marketplace_service = game:GetService("MarketplaceService")
local replicated_storage = game:GetService("ReplicatedStorage")

-- Wait for essential services
local success, remote_func = pcall(function()
    return replicated_storage:WaitForChild("RemoteFunction", 10)
end)
if not success then
    warn("RemoteFunction not found")
    return
end

local success, remote_event = pcall(function()
    return replicated_storage:WaitForChild("RemoteEvent", 10)
end)
if not success then
    warn("RemoteEvent not found")
    return
end

local player_gui = local_player:WaitForChild("PlayerGui", 10)
if not player_gui then
    warn("PlayerGui not found")
    return
end

local back_to_lobby_running = false
local auto_pickups_running = false
local auto_skip_running = false
local anti_lag_running = false

local MaxLogs = 35
local Logs = {}

local ColorMap = {
    green = "#2BFFAE",
    red = "#FF3A3A",
    orange = "#FFA500",
    yellow = "#FFF300",
}

-- // icon item ids
local ItemNames = {
    ["17447507910"] = "Timescale Ticket(s)",
    ["17438486690"] = "Range Flag(s)",
    ["17438486138"] = "Damage Flag(s)",
    ["17438487774"] = "Cooldown Flag(s)",
    ["17429537022"] = "Blizzard(s)",
    ["17448596749"] = "Napalm Strike(s)",
    ["18493073533"] = "Spin Ticket(s)",
    ["17429548305"] = "Supply Drop(s)",
    ["18443277308"] = "Low Grade Consumable Crate(s)",
    ["136180382135048"] = "Santa Radio(s)",
    ["18443277106"] = "Mid Grade Consumable Crate(s)",
    ["18443277591"] = "High Grade Consumable Crate(s)",
    ["132155797622156"] = "Christmas Tree(s)",
    ["124065875200929"] = "Fruit Cake(s)",
    ["17429541513"] = "Barricade(s)",
    ["110415073436604"] = "Holy Hand Grenade(s)",
    ["139414922355803"] = "Present Clusters(s)"
}

-- // tower management core
local TDS = {
    placed_towers = {},
    active_strat = true,
    matchmaking_map = {
        ["Hardcore"] = "hardcore",
        ["Pizza Party"] = "halloween",
        ["Badlands"] = "badlands",
        ["Polluted"] = "polluted"
    }
}

local upgrade_history = {}

-- // shared for addons
shared.TDS_Table = TDS

-- // console logging helpers
local function classifyColor(text)
    local t = text:lower()

    if t:find("error")
        or t:find("failed")
        or t:find("invalid")
        or t:find("missing")
        or t:find("cannot")
        or t:find("nil")
        or t:find("no ") then
        return "red"
    end

    if t:find("warning")
        or t:find("issue")
        or t:find("retry")
        or t:find("skipped")
        or t:find("delay") then
        return "orange"
    end

    if t:find("loaded")
        or t:find("detected")
        or t:find("updated")
        or t:find("adjusted")
        or t:find("processing") then
        return "yellow"
    end

    return "green"
end

-- // console logging
local function log(text, color)
    if not Console then return end
    
    color = color or classifyColor(text)
    local hex = ColorMap[color] or ColorMap.green
    local formatted = "<font color='" .. hex .. "'>" .. text .. "</font>"

    local ConsoleLogExample = Instance.new("TextLabel")
    ConsoleLogExample.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    ConsoleLogExample.BackgroundTransparency = 1
    ConsoleLogExample.BorderSizePixel = 0
    ConsoleLogExample.Size = UDim2.new(1, -8, 0, 0)
    ConsoleLogExample.Font = Enum.Font.SourceSansSemibold
    ConsoleLogExample.RichText = true
    ConsoleLogExample.Text = formatted
    ConsoleLogExample.TextSize = 14
    ConsoleLogExample.TextWrapped = true
    ConsoleLogExample.TextXAlignment = Enum.TextXAlignment.Left
    ConsoleLogExample.TextYAlignment = Enum.TextYAlignment.Top
    ConsoleLogExample.TextColor3 = Color3.fromRGB(255,255,255)
    ConsoleLogExample.AutomaticSize = Enum.AutomaticSize.Y
    ConsoleLogExample.Parent = Console

    table.insert(Logs, ConsoleLogExample)

    if #Logs > MaxLogs then
        Logs[1]:Destroy()
        table.remove(Logs, 1)
    end

    task.wait()
    if Console.UIListLayout then
        Console.CanvasSize = UDim2.new(0,0,0,Console.UIListLayout.AbsoluteContentSize.Y)
        Console.CanvasPosition = Vector2.new(0, Console.CanvasSize.Y.Offset)
    end
end

-- // currency tracking
local start_coins, current_total_coins, start_gems, current_total_gems = 0, 0, 0, 0
if game_state == "GAME" then
    pcall(function()
        repeat task.wait(1) until local_player:FindFirstChild("Coins")
        start_coins = local_player.Coins.Value
        current_total_coins = start_coins
        start_gems = local_player.Gems.Value
        current_total_gems = start_gems
    end)
end

-- // Function to get equipped towers string
local function get_equipped_towers_string()
    local success, result = pcall(function()
        return remote_func:InvokeServer("Inventory", "GetTowerLoadout")
    end)
    
    if success and type(result) == "table" then
        local tower_names = {}
        for _, tower_id in ipairs(result) do
            table.insert(tower_names, tower_id)
        end
        
        if #tower_names > 0 then
            return table.concat(tower_names, ", ")
        end
    end
    
    return "_No towers detected_"
end

-- // check if remote returned valid
local function check_res_ok(data)
    if data == true then return true end
    if type(data) == "table" and data.Success == true then return true end

    local success, is_model = pcall(function()
        return data and data:IsA("Model")
    end)
    
    if success and is_model then return true end
    if type(data) == "userdata" then return true end

    return false
end

-- // scrap ui for match data
local function get_all_rewards()
    local results = {
        Coins = 0, 
        Gems = 0, 
        XP = 0, 
        Wave = 0,
        Level = 0,
        Time = "00:00",
        Status = "UNKNOWN",
        Others = {} 
    }
    
    local ui_root = player_gui:FindFirstChild("ReactGameNewRewards")
    if not ui_root then return results end
    
    local main_frame = ui_root:FindFirstChild("Frame")
    local game_over = main_frame and main_frame:FindFirstChild("gameOver")
    local rewards_screen = game_over and game_over:FindFirstChild("RewardsScreen")
    
    if not rewards_screen then return results end
    
    local game_stats = rewards_screen:FindFirstChild("gameStats")
    local stats_list = game_stats and game_stats:FindFirstChild("stats")
    
    if stats_list then
        for _, frame in ipairs(stats_list:GetChildren()) do
            local l1 = frame:FindFirstChild("textLabel")
            local l2 = frame:FindFirstChild("textLabel2")
            if l1 and l2 and l1.Text:find("Time Completed:") then
                results.Time = l2.Text
                break
            end
        end
    end

    local top_banner = rewards_screen:FindFirstChild("RewardBanner")
    if top_banner and top_banner:FindFirstChild("textLabel") then
        local txt = top_banner.textLabel.Text:upper()
        results.Status = txt:find("TRIUMPH") and "WIN" or (txt:find("LOST") and "LOSS" or "UNKNOWN")
    end

    local level_value = local_player.Level
    if level_value then
        results.Level = level_value.Value or 0
    end

    local wave_display = player_gui:FindFirstChild("ReactGameTopGameDisplay")
    if wave_display then
        local label = wave_display.Frame.wave.container.value
        if label then
            local wave_num = label.Text:match("^(%d+)")
            if wave_num then
                results.Wave = tonumber(wave_num) or 0
            end
        end
    end

    local section_rewards = rewards_screen:FindFirstChild("RewardsSection")
    if section_rewards then
        for _, item in ipairs(section_rewards:GetChildren()) do
            if tonumber(item.Name) then 
                local icon_id = "0"
                local img = item:FindFirstChildWhichIsA("ImageLabel", true)
                if img then icon_id = img.Image:match("%d+") or "0" end

                for _, child in ipairs(item:GetDescendants()) do
                    if child:IsA("TextLabel") then
                        local text = child.Text
                        local amt = tonumber(text:match("(%d+)")) or 0
                        
                        if text:find("Coins") then
                            results.Coins = amt
                        elseif text:find("Gems") then
                            results.Gems = amt
                        elseif text:find("XP") then
                            results.XP = amt
                        elseif text:lower():find("x%d+") then 
                            local displayName = ItemNames[icon_id] or "Unknown Item (" .. icon_id .. ")"
                            table.insert(results.Others, {Amount = text:match("x%d+"), Name = displayName})
                        end
                    end
                end
            end
        end
    end
    
    return results
end

-- // lobby / teleporting
local function send_to_lobby()
    task.wait(1)
    local lobby_remote = game.ReplicatedStorage.Network.Teleport["RE:backToLobby"]
    lobby_remote:FireServer()
end

local function handle_post_match()
    local ui_root
    repeat
        task.wait(1)

        local root = player_gui:FindFirstChild("ReactGameNewRewards")
        local frame = root and root:FindFirstChild("Frame")
        local gameOver = frame and frame:FindFirstChild("gameOver")
        local rewards_screen = gameOver and gameOver:FindFirstChild("RewardsScreen")
        ui_root = rewards_screen and rewards_screen:FindFirstChild("RewardsSection")
    until ui_root

    if not ui_root then return send_to_lobby() end

    if not _G.SendWebhook or not _G.Webhook then
        send_to_lobby()
        return
    end

    local match = get_all_rewards()

    current_total_coins += match.Coins
    current_total_gems += match.Gems

    local bonus_string = ""
    if #match.Others > 0 then
        for _, res in ipairs(match.Others) do
            bonus_string = bonus_string .. "ğŸ **" .. res.Amount .. " " .. res.Name .. "**\n"
        end
    else
        bonus_string = "_No bonus items this match_"
    end

    -- Send match result webhook
    local match_result_payload = {
        username = "Arma's Auto Grind",
        avatar_url = "https://i.pinimg.com/originals/xx/xx/xx.jpg",
        embeds = {{
            title = match.Status == "WIN" and "ğŸ† TRIUMPH ACHIEVED" or "ğŸ’€ BAD RNG",
            description =
                "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" ..
                "**ğŸ® Tower Defense Simulator**\n" ..
                "Automated match report\n" ..
                "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",

            color = match.Status == "WIN" and 0x2ecc71 or 0xe74c3c,

            fields = {
                {
                    name = "ğŸ“Š Match Info",
                    value =
                        "**Status:** " .. match.Status .. "\n" ..
                        "**Wave:** " .. match.Wave .. "\n" ..
                        "**Time:** " .. match.Time .. "\n" ..
                        "**Level:** " .. match.Level,
                    inline = true
                },
                {
                    name = "ğŸ—ºï¸ Game Details",
                    value =
                        "**Mode:** Survival\n" ..
                        "**Map:** Auto Selected\n" ..
                        "**Difficulty:** Hardcore",
                    inline = true
                },
                {
                    name = "ğŸ’° Rewards Gained",
                    value =
                        "ğŸª™ **Coins:** +" .. match.Coins .. "\n" ..
                        "ğŸ’ **Gems:** +" .. match.Gems .. "\n" ..
                        "â­ **XP:** +" .. match.XP,
                    inline = true
                },
                {
                    name = "ğŸ Bonus Drops",
                    value = bonus_string,
                    inline = false
                },
                {
                    name = "ğŸ“ˆ Session Progress",
                    value =
                        "ğŸª™ **Total Coins:** " .. current_total_coins .. "\n" ..
                        "ğŸ’ **Total Gems:** " .. current_total_gems,
                    inline = true
                },
                {
                    name = "ğŸ‘¤ Player",
                    value =
                        "**Name:** " .. local_player.Name .. "\n" ..
                        "**User ID:** " .. local_player.UserId,
                    inline = true
                }
            },

            footer = {
                text = "Autostrat 2.0 By Arma â€¢ Match Result",
                icon_url = "https://i.pinimg.com/originals/xx/xx/xx.jpg"
            },

            timestamp = DateTime.now():ToIsoDate()
        }}
    }

    pcall(function()
        send_request({
            Url = _G.Webhook,
            Method = "POST",
            Headers = { ["Content-Type"] = "application/json" },
            Body = game:GetService("HttpService"):JSONEncode(match_result_payload)
        })
    end)

    task.wait(1.5)
    send_to_lobby()
end

local function log_match_start()
    if not _G.SendWebhook or not _G.Webhook then return end
    if type(_G.Webhook) ~= "string" or _G.Webhook == "" then return end
    if _G.Webhook:find("YOUR%-WEBHOOK") then return end
    
    -- Get equipped towers
    local equipped_towers_string = get_equipped_towers_string()
    
    local match_start_payload = {
        username = "Arma's Auto Grind",
        avatar_url = "https://i.pinimg.com/originals/xx/xx/xx.jpg",
        embeds = {{
            title = "ğŸš€ MATCH STARTED",
            description =
                "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" ..
                "**ğŸ® Tower Defense Simulator**\n" ..
                "AutoStrat deployment active\n" ..
                "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",

            color = 0x3498db,

            fields = {
                {
                    name = "ğŸª™ Starting Resources",
                    value =
                        "ğŸª™ **Coins:** " .. start_coins .. "\n" ..
                        "ğŸ’ **Gems:** " .. start_gems,
                    inline = true
                },
                {
                    name = "âš™ï¸ Script Status",
                    value =
                        "ğŸŸ¢ Running\n" ..
                        "ğŸ§  Automation Enabled",
                    inline = true
                },
                {
                    name = "ğŸ’¼ Loadout (Equipped Towers)",
                    value = equipped_towers_string,
                    inline = false
                },
                {
                    name = "ğŸ‘¤ Player",
                    value =
                        "**Name:** " .. local_player.Name .. "\n" ..
                        "**User ID:** " .. local_player.UserId,
                    inline = true
                }
            },

            footer = {
                text = "Autostrat 2.0 By Arma â€¢ Match Start",
                icon_url = "https://i.pinimg.com/originals/xx/xx/xx.jpg"
            },

            timestamp = DateTime.now():ToIsoDate()
        }}
    }

    pcall(function()
        send_request({
            Url = _G.Webhook,
            Method = "POST",
            Headers = { ["Content-Type"] = "application/json" },
            Body = game:GetService("HttpService"):JSONEncode(match_start_payload)
        })
    end)
end

-- Function to send ongoing match webhook
local function send_ongoing_match_update()
    if not _G.SendWebhook or not _G.Webhook then return end
    if type(_G.Webhook) ~= "string" or _G.Webhook == "" then return end
    
    local current_coins = local_player.Coins and local_player.Coins.Value or 0
    local current_gems = local_player.Gems and local_player.Gems.Value or 0
    
    local ongoing_payload = {
        username = "Arma's Auto Grind",
        avatar_url = "https://i.pinimg.com/originals/xx/xx/xx.jpg",
        embeds = {{
            title = "â³ MATCH STILL IN PROGRESS",
            description =
                "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" ..
                "**Automated grinding is ongoing**\n" ..
                "Please do not interrupt\n" ..
                "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”",

            color = 0xf1c40f,

            fields = {
                {
                    name = "ğŸ‘¤ Player",
                    value = local_player.Name,
                    inline = true
                },
                {
                    name = "ğŸª™ Current Resources",
                    value =
                        "ğŸª™ **Coins:** " .. current_coins .. "\n" ..
                        "ğŸ’ **Gems:** " .. current_gems,
                    inline = true
                }
            },

            footer = {
                text = "Autostrat 2.0 By Arma â€¢ Match Ongoing",
                icon_url = "https://i.pinimg.com/originals/xx/xx/xx.jpg"
            },

            timestamp = DateTime.now():ToIsoDate()
        }}
    }

    pcall(function()
        send_request({
            Url = _G.Webhook,
            Method = "POST",
            Headers = { ["Content-Type"] = "application/json" },
            Body = game:GetService("HttpService"):JSONEncode(ongoing_payload)
        })
    end)
end

-- // voting & map selection
local function run_vote_skip()
    local success = pcall(function()
        remote_func:InvokeServer("Voting", "Skip")
    end)
    return success
end

local function match_ready_up()
    local ui_overrides = player_gui:WaitForChild("ReactOverridesVote", 10)
    if not ui_overrides then return end
    
    local main_frame = ui_overrides:WaitForChild("Frame", 5)
    if not main_frame then return end

    local vote_ready = nil
    local attempts = 0
    
    while not vote_ready and attempts < 20 do
        local vote_node = main_frame:FindFirstChild("votes")
        if vote_node then
            local container = vote_node:FindFirstChild("container")
            if container then
                vote_ready = container:FindFirstChild("ready")
            end
        end
        
        if not vote_ready then
            task.wait(0.5)
            attempts = attempts + 1
        end
    end

    if not vote_ready then return end

    run_vote_skip()
    log_match_start()
    
    -- Send ongoing match update after 30 seconds
    task.wait(30)
    send_ongoing_match_update()
end

local function cast_map_vote(map_id, pos_vec)
    local target_map = map_id or "Simplicity"
    local target_pos = pos_vec or Vector3.new(0,0,0)
    remote_event:FireServer("LobbyVoting", "Vote", target_map, target_pos)
    log("Cast map vote: " .. target_map, "green")
end

local function lobby_ready_up()
    pcall(function()
        remote_event:FireServer("LobbyVoting", "Ready")
        log("Lobby ready up sent", "green")
    end)
end

local function select_map_override(map_id, ...)
    local args = {...}

    if args[#args] == "vip" then
        remote_func:InvokeServer("LobbyVoting", "Override", map_id)
    end

    task.wait(3)
    cast_map_vote(map_id, Vector3.new(12.59, 10.64, 52.01))
    task.wait(1)
    lobby_ready_up()
    match_ready_up()
end

local function cast_modifier_vote(mods_table)
    local bulk_modifiers = replicated_storage:WaitForChild("Network"):WaitForChild("Modifiers"):WaitForChild("RF:BulkVoteModifiers")
    local selected_mods = mods_table or {
        HiddenEnemies = true, Glass = true, ExplodingEnemies = true,
        Limitation = true, Committed = true, HealthyEnemies = true,
        SpeedyEnemies = true, Quarantine = true, Fog = true,
        FlyingEnemies = true, Broke = true, Jailed = true, Inflation = true
    }

    pcall(function()
        bulk_modifiers:InvokeServer(selected_mods)
    end)
end

-- Fix the timescale logic functions
local function get_current_wave()
    local wave_display = player_gui:FindFirstChild("ReactGameTopGameDisplay")
    if wave_display then
        local label = wave_display.Frame.wave.container.value
        if label then
            local text = label.Text
            local wave_num = text:match("(%d+)")
            return tonumber(wave_num) or 0
        end
    end
    return 0
end

-- Main functions remain the same but with error handling...

-- Start the main processes with error handling
pcall(function()
    log("AutoStrat loaded successfully!", "green")
    
    if game_state == "GAME" then
        send_ongoing_match_update()
    end
end)

return TDS
